{% extends "customer_base.html" %}

{% block title %}Book an Appointment - White Thorn Piercing{% endblock %}

{% block content %}
<style>
    .category-accordion {
        margin-bottom: 10px;
    }

    .category-header {
        background: rgba(201, 169, 98, 0.15);
        border: 1px solid rgba(201, 169, 98, 0.3);
        border-radius: 8px;
        padding: 15px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .category-header:hover {
        background: rgba(201, 169, 98, 0.25);
        border-color: var(--gold);
    }

    .category-header h3 {
        margin: 0;
        color: var(--gold);
        font-family: 'Cinzel', serif;
        font-size: 18px;
    }

    .category-header .service-count {
        color: rgba(245, 241, 232, 0.6);
        font-size: 14px;
    }

    .category-header .arrow {
        color: var(--gold);
        font-size: 20px;
        transition: transform 0.3s ease;
    }

    .category-header.open .arrow {
        transform: rotate(180deg);
    }

    .category-services {
        display: none;
        padding: 10px 0;
    }

    .category-services.open {
        display: block;
    }

    .category-services .service-card {
        margin-bottom: 10px;
    }

    .category-services .service-card:last-child {
        margin-bottom: 0;
    }

    /* Multi-select service card styling */
    .service-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(201, 169, 98, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .service-card:hover {
        background: rgba(201, 169, 98, 0.1);
        border-color: var(--gold);
    }

    .service-card.selected {
        background: rgba(201, 169, 98, 0.15);
        border-color: var(--gold);
    }

    .service-checkbox {
        width: 22px;
        height: 22px;
        border: 2px solid rgba(201, 169, 98, 0.5);
        border-radius: 4px;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .service-card.selected .service-checkbox {
        background: var(--gold);
        border-color: var(--gold);
    }

    .service-checkbox svg {
        display: none;
        width: 14px;
        height: 14px;
        fill: var(--darker-green);
    }

    .service-card.selected .service-checkbox svg {
        display: block;
    }

    .service-card-content {
        display: flex;
        align-items: center;
        flex: 1;
    }

    /* Date picker styling */
    .date-picker-section {
        display: none;
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid rgba(201, 169, 98, 0.3);
    }

    .date-picker-section.show {
        display: block;
    }

    /* Selected services summary */
    .selected-services-summary {
        background: rgba(201, 169, 98, 0.15);
        border: 1px solid var(--gold);
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
    }

    .selected-services-summary h3 {
        margin: 0 0 12px 0;
        color: var(--gold);
        font-size: 16px;
    }

    .selected-service-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(201, 169, 98, 0.2);
        align-items: center;
    }

    .selected-service-item:last-of-type {
        border-bottom: none;
    }

    .selected-service-item .name {
        color: var(--cream);
    }

    .selected-service-item .duration {
        color: rgba(245, 241, 232, 0.6);
        font-size: 13px;
    }

    .selected-service-item .price {
        color: var(--gold);
        font-family: 'Cinzel', serif;
    }

    .selected-service-item .remove-btn {
        background: transparent;
        border: none;
        color: rgba(231, 76, 60, 0.8);
        cursor: pointer;
        padding: 4px 8px;
        margin: 0;
        font-size: 18px;
        line-height: 1;
    }

    .selected-service-item .remove-btn:hover {
        color: #e74c3c;
    }

    .summary-totals {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(201, 169, 98, 0.3);
    }

    .summary-total-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
    }

    .summary-total-row .label {
        color: rgba(245, 241, 232, 0.7);
    }

    .summary-total-row .value {
        color: var(--gold);
        font-weight: 600;
    }

    .summary-total-row.grand-total {
        font-size: 18px;
    }

    .summary-total-row.grand-total .value {
        font-family: 'Cinzel', serif;
        font-size: 22px;
    }

    .summary-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .add-more-btn {
        flex: 1;
        font-size: 13px;
        padding: 10px 15px;
        margin: 0;
        background: transparent;
        border: 1px solid var(--gold);
        color: var(--gold);
    }

    .add-more-btn:hover {
        background: rgba(201, 169, 98, 0.2);
    }

    .continue-booking-btn {
        flex: 2;
        font-size: 13px;
        padding: 10px 15px;
        margin: 0;
    }

    /* Time slots section */
    .time-slots-section {
        display: none;
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid rgba(201, 169, 98, 0.3);
    }

    .time-slots-section.show {
        display: block;
    }

    .slots-loading {
        text-align: center;
        padding: 30px;
        color: rgba(245, 241, 232, 0.6);
    }

    .slots-loading .spinner {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 3px solid rgba(201, 169, 98, 0.3);
        border-top-color: var(--gold);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .no-slots-message {
        text-align: center;
        padding: 25px;
        background: rgba(231, 76, 60, 0.15);
        border: 1px solid rgba(231, 76, 60, 0.4);
        border-radius: 8px;
        color: #f5a5a0;
    }

    .no-slots-message p {
        margin: 0 0 10px 0;
    }

    .no-slots-message .suggestion {
        font-size: 13px;
        color: rgba(245, 241, 232, 0.6);
    }

    /* Slots grid improvements */
    .slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }

    .slot-btn {
        padding: 12px 8px;
        background: rgba(201, 169, 98, 0.1);
        border: 1px solid rgba(201, 169, 98, 0.3);
        border-radius: 6px;
        color: var(--cream);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-size: 15px;
    }

    .slot-btn:hover {
        background: rgba(201, 169, 98, 0.2);
        border-color: var(--gold);
    }

    .slot-btn.selected {
        background: var(--gold);
        color: var(--darker-green);
        border-color: var(--gold);
        font-weight: 600;
    }

    /* Continue button */
    .continue-section {
        display: none;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid rgba(201, 169, 98, 0.3);
    }

    .continue-section.show {
        display: block;
    }

    .booking-summary {
        background: rgba(39, 174, 96, 0.15);
        border: 1px solid rgba(39, 174, 96, 0.4);
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        color: #7ed6a5;
    }

    .booking-summary .summary-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .booking-summary .summary-line:last-child {
        margin-bottom: 0;
    }

    .booking-summary .label {
        color: rgba(126, 214, 165, 0.7);
    }

    /* Quick date navigation */
    .quick-dates {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .quick-date-btn {
        padding: 8px 14px;
        background: rgba(201, 169, 98, 0.1);
        border: 1px solid rgba(201, 169, 98, 0.3);
        border-radius: 20px;
        color: var(--cream);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        margin: 0;
    }

    .quick-date-btn:hover {
        background: rgba(201, 169, 98, 0.2);
        border-color: var(--gold);
    }

    .quick-date-btn.active {
        background: var(--gold);
        color: var(--darker-green);
        border-color: var(--gold);
    }

    /* Multi-service hint */
    .multi-service-hint {
        background: rgba(201, 169, 98, 0.1);
        border: 1px solid rgba(201, 169, 98, 0.2);
        border-radius: 6px;
        padding: 12px 15px;
        margin-bottom: 15px;
        font-size: 14px;
        color: rgba(245, 241, 232, 0.7);
    }

    .multi-service-hint strong {
        color: var(--gold);
    }
</style>

<div class="container">
    <h1>Book an Appointment</h1>
    <p class="subtitle">Select your services, date and time</p>

    {% if error %}
        <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <!-- Selected Services Summary (shown when services are selected) -->
    <div id="selectedServicesSummary" class="selected-services-summary" style="display: none;">
        <h3>Your Selected Services</h3>
        <div id="selectedServicesList"></div>
        <div class="summary-totals">
            <div class="summary-total-row">
                <span class="label">Total Duration:</span>
                <span class="value" id="totalDuration">0 minutes</span>
            </div>
            <div class="summary-total-row grand-total">
                <span class="label">Total Price:</span>
                <span class="value" id="totalPrice">Â£0.00</span>
            </div>
        </div>
        <div class="summary-actions">
            <button type="button" class="btn add-more-btn" id="addMoreBtn">+ Add Another Service</button>
            <button type="button" class="btn continue-booking-btn" id="continueToDateBtn">Choose Date & Time â†’</button>
        </div>
    </div>

    <!-- Step 1: Service Selection -->
    <div id="serviceSelection">
        <label>Choose Your Services</label>
        <div class="multi-service-hint">
            <strong>Tip:</strong> You can select multiple services to book them together. Your appointment duration will be the combined time of all selected services.
        </div>

        {% set has_services = (categories and categories|selectattr('services')|list) or uncategorized %}

        {% if has_services %}
            <div style="margin-bottom: 20px;">
                {% for category in categories %}
                    {% set active_services = category.services | selectattr('is_active') | list %}
                    {% if active_services %}
                        <div class="category-accordion">
                            <div class="category-header">
                                <div>
                                    <h3>{{ category.name }}</h3>
                                    <span class="service-count">{{ active_services|length }} service{{ 's' if active_services|length != 1 else '' }}</span>
                                </div>
                                <span class="arrow">â–¼</span>
                            </div>
                            <div class="category-services">
                                {% for service in active_services %}
                                    <div class="service-card"
                                         data-service-id="{{ service.id }}"
                                         data-service-name="{{ service.name }}"
                                         data-service-duration="{{ service.duration_minutes }}"
                                         data-service-description="{{ service.description or '' }}"
                                         data-service-price="{{ service.price or 0 }}">
                                        <div class="service-card-content">
                                            <div class="service-checkbox">
                                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                            </div>
                                            <div class="service-info">
                                                <h3>{{ service.name }}</h3>
                                                <p>{{ service.duration_minutes }} minutes{% if service.description %} &bull; {{ service.description }}{% endif %}</p>
                                            </div>
                                        </div>
                                        <div class="service-price">
                                            {% if service.price %}Â£{{ "%.2f"|format(service.price) }}{% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                {% if uncategorized %}
                    <div class="category-accordion">
                        <div class="category-header">
                            <div>
                                <h3>Other Services</h3>
                                <span class="service-count">{{ uncategorized|length }} service{{ 's' if uncategorized|length != 1 else '' }}</span>
                            </div>
                            <span class="arrow">â–¼</span>
                        </div>
                        <div class="category-services">
                            {% for service in uncategorized %}
                                <div class="service-card"
                                     data-service-id="{{ service.id }}"
                                     data-service-name="{{ service.name }}"
                                     data-service-duration="{{ service.duration_minutes }}"
                                     data-service-description="{{ service.description or '' }}"
                                     data-service-price="{{ service.price or 0 }}">
                                    <div class="service-card-content">
                                        <div class="service-checkbox">
                                            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                        </div>
                                        <div class="service-info">
                                            <h3>{{ service.name }}</h3>
                                            <p>{{ service.duration_minutes }} minutes{% if service.description %} &bull; {{ service.description }}{% endif %}</p>
                                        </div>
                                    </div>
                                    <div class="service-price">
                                        {% if service.price %}Â£{{ "%.2f"|format(service.price) }}{% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-info">
                No services available at this time. Please check back later or contact us directly.
            </div>
        {% endif %}
    </div>

    <!-- Step 2: Date Selection (shown after services confirmed) -->
    <div id="dateSelection" class="date-picker-section">
        <label>Choose a Date</label>

        <!-- Quick date buttons -->
        <div class="quick-dates" id="quickDates"></div>

        <input type="date" id="bookingDate" min="{{ today }}" max="{{ max_date }}" value="{{ today }}">
    </div>

    <!-- Step 3: Time Slots (shown after date selected) -->
    <div id="timeSlotsSection" class="time-slots-section">
        <label>Choose a Time</label>

        <div id="slotsLoading" class="slots-loading" style="display: none;">
            <div class="spinner"></div>
            <div>Checking availability...</div>
        </div>

        <div id="noSlotsMessage" class="no-slots-message" style="display: none;">
            <p>ðŸ˜” No available slots on this date</p>
            <div class="suggestion">Try selecting a different date above</div>
        </div>

        <div id="slotsGrid" class="slots-grid"></div>
    </div>

    <!-- Step 4: Continue to booking (shown after time selected) -->
    <div id="continueSection" class="continue-section">
        <div class="booking-summary">
            <div class="summary-line">
                <span class="label">Services:</span>
                <span id="finalServices"></span>
            </div>
            <div class="summary-line">
                <span class="label">Date:</span>
                <span id="finalDate"></span>
            </div>
            <div class="summary-line">
                <span class="label">Time:</span>
                <span id="finalTime"></span>
            </div>
            <div class="summary-line">
                <span class="label">Duration:</span>
                <span id="finalDuration"></span>
            </div>
        </div>

        <form id="continueForm" method="POST" action="/book/confirm">
            <input type="hidden" name="service_ids" id="formServiceIds">
            <input type="hidden" name="booking_date" id="formBookingDate">
            <input type="hidden" name="booking_time" id="formBookingTime">
            <input type="hidden" name="total_duration" id="formTotalDuration">
            <button type="submit">Continue to Details â†’</button>
        </form>
    </div>
</div>

<script>
    // State - now tracking multiple services
    var selectedServices = []; // Array of {id, name, duration, description, price}
    var selectedDate = '{{ today }}';
    var selectedTime = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Category accordion handlers
        document.querySelectorAll('.category-header').forEach(function(header) {
            header.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleCategory(this);
            });
        });

        // Service card handlers
        document.querySelectorAll('.service-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleService(this);
            });
        });

        // Add more services button
        document.getElementById('addMoreBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            showServiceSelection();
        });

        // Continue to date/time button
        document.getElementById('continueToDateBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            proceedToDateSelection();
        });

        // Date input handler
        document.getElementById('bookingDate').addEventListener('change', function() {
            loadAvailableSlots();
        });
    });

    // Category accordion
    function toggleCategory(header) {
        var wasOpen = header.classList.contains('open');

        // Close all categories
        document.querySelectorAll('.category-header').forEach(function(h) {
            h.classList.remove('open');
            h.nextElementSibling.classList.remove('open');
        });

        // If it wasn't open, open it
        if (!wasOpen) {
            header.classList.add('open');
            header.nextElementSibling.classList.add('open');
        }
    }

    // Toggle service selection
    function toggleService(card) {
        var serviceId = card.getAttribute('data-service-id');
        var serviceName = card.getAttribute('data-service-name');
        var serviceDuration = parseInt(card.getAttribute('data-service-duration'));
        var serviceDescription = card.getAttribute('data-service-description');
        var servicePrice = parseFloat(card.getAttribute('data-service-price')) || 0;

        // Check if already selected
        var existingIndex = -1;
        for (var i = 0; i < selectedServices.length; i++) {
            if (selectedServices[i].id === serviceId) {
                existingIndex = i;
                break;
            }
        }

        if (existingIndex >= 0) {
            // Remove from selection
            selectedServices.splice(existingIndex, 1);
            card.classList.remove('selected');
        } else {
            // Add to selection
            selectedServices.push({
                id: serviceId,
                name: serviceName,
                duration: serviceDuration,
                description: serviceDescription,
                price: servicePrice
            });
            card.classList.add('selected');
        }

        // Reset time selection when services change
        selectedTime = null;
        document.getElementById('continueSection').classList.remove('show');

        // Update summary display
        updateServicesSummary();
    }

    // Remove service from selection
    function removeService(serviceId) {
        // Find and remove from array
        for (var i = 0; i < selectedServices.length; i++) {
            if (selectedServices[i].id === serviceId) {
                selectedServices.splice(i, 1);
                break;
            }
        }

        // Update card visual state
        document.querySelectorAll('.service-card').forEach(function(card) {
            if (card.getAttribute('data-service-id') === serviceId) {
                card.classList.remove('selected');
            }
        });

        // Reset time selection
        selectedTime = null;
        document.getElementById('continueSection').classList.remove('show');

        // Update summary
        updateServicesSummary();

        // If no services left, go back to service selection
        if (selectedServices.length === 0) {
            showServiceSelection();
        }
    }

    // Update the services summary display
    function updateServicesSummary() {
        var summaryDiv = document.getElementById('selectedServicesSummary');
        var listDiv = document.getElementById('selectedServicesList');

        if (selectedServices.length === 0) {
            summaryDiv.style.display = 'none';
            return;
        }

        // Build list HTML
        var listHTML = '';
        var totalDuration = 0;
        var totalPrice = 0;

        selectedServices.forEach(function(service) {
            totalDuration += service.duration;
            totalPrice += service.price;

            listHTML += '<div class="selected-service-item">' +
                '<div>' +
                    '<div class="name">' + escapeHtml(service.name) + '</div>' +
                    '<div class="duration">' + service.duration + ' minutes</div>' +
                '</div>' +
                '<div style="display: flex; align-items: center; gap: 15px;">' +
                    (service.price > 0 ? '<span class="price">Â£' + service.price.toFixed(2) + '</span>' : '') +
                    '<button type="button" class="remove-btn" onclick="removeService(\'' + service.id + '\')" title="Remove">Ã—</button>' +
                '</div>' +
            '</div>';
        });

        listDiv.innerHTML = listHTML;
        document.getElementById('totalDuration').textContent = totalDuration + ' minutes';
        document.getElementById('totalPrice').textContent = 'Â£' + totalPrice.toFixed(2);

        summaryDiv.style.display = 'block';
    }

    // Show service selection (for adding more)
    function showServiceSelection() {
        document.getElementById('serviceSelection').style.display = 'block';
        document.getElementById('dateSelection').classList.remove('show');
        document.getElementById('timeSlotsSection').classList.remove('show');
        document.getElementById('continueSection').classList.remove('show');
    }

    // Proceed to date/time selection
    function proceedToDateSelection() {
        if (selectedServices.length === 0) {
            alert('Please select at least one service.');
            return;
        }

        document.getElementById('serviceSelection').style.display = 'none';
        document.getElementById('dateSelection').classList.add('show');
        document.getElementById('timeSlotsSection').classList.add('show');

        // Generate quick date buttons
        generateQuickDates();

        // Load slots for current date
        loadAvailableSlots();
    }

    // Generate quick date buttons (Today, Tomorrow, + next 5 days)
    function generateQuickDates() {
        var container = document.getElementById('quickDates');
        container.innerHTML = '';

        var today = new Date();
        var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        for (var i = 0; i < 7; i++) {
            var date = new Date(today);
            date.setDate(today.getDate() + i);

            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var dateStr = year + '-' + month + '-' + day;

            var dayName = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : dayNames[date.getDay()];
            var dayNum = date.getDate();

            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'quick-date-btn' + (dateStr === selectedDate ? ' active' : '');
            btn.innerHTML = dayName + '<br><small>' + dayNum + '</small>';
            btn.setAttribute('data-date', dateStr);
            btn.addEventListener('click', function() {
                selectQuickDate(this.getAttribute('data-date'));
            });
            container.appendChild(btn);
        }
    }

    // Quick date selection
    function selectQuickDate(dateStr) {
        selectedDate = dateStr;
        document.getElementById('bookingDate').value = dateStr;

        // Update quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(function(b) {
            b.classList.remove('active');
            if (b.getAttribute('data-date') === dateStr) {
                b.classList.add('active');
            }
        });

        loadAvailableSlots();
    }

    // Calculate total duration of selected services
    function getTotalDuration() {
        var total = 0;
        selectedServices.forEach(function(service) {
            total += service.duration;
        });
        return total;
    }

    // Load available slots for selected date with total duration
    function loadAvailableSlots() {
        if (selectedServices.length === 0) return;

        selectedDate = document.getElementById('bookingDate').value;
        selectedTime = null;

        // Update quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-date') === selectedDate);
        });

        // Show loading state
        document.getElementById('slotsLoading').style.display = 'block';
        document.getElementById('slotsGrid').innerHTML = '';
        document.getElementById('noSlotsMessage').style.display = 'none';
        document.getElementById('continueSection').classList.remove('show');

        // Calculate total duration
        var totalDuration = getTotalDuration();

        // Build service IDs string
        var serviceIds = selectedServices.map(function(s) { return s.id; }).join(',');

        // Fetch slots with total duration
        fetch('/api/available-slots?service_ids=' + serviceIds + '&date=' + selectedDate + '&total_duration=' + totalDuration)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                document.getElementById('slotsLoading').style.display = 'none';

                if (data.slots && data.slots.length > 0) {
                    renderSlots(data.slots);
                } else {
                    document.getElementById('noSlotsMessage').style.display = 'block';
                }
            })
            .catch(function(error) {
                console.error('Error loading slots:', error);
                document.getElementById('slotsLoading').style.display = 'none';
                document.getElementById('noSlotsMessage').style.display = 'block';
            });
    }

    // Render time slots
    function renderSlots(slots) {
        var grid = document.getElementById('slotsGrid');
        grid.innerHTML = '';

        slots.forEach(function(slot) {
            var btn = document.createElement('div');
            btn.className = 'slot-btn';
            btn.textContent = slot.start;
            btn.setAttribute('data-time', slot.start);
            btn.addEventListener('click', function() {
                selectTimeSlot(this.getAttribute('data-time'), this);
            });
            grid.appendChild(btn);
        });
    }

    // Time slot selection
    function selectTimeSlot(time, btn) {
        selectedTime = time;

        document.querySelectorAll('.slot-btn').forEach(function(b) {
            b.classList.remove('selected');
        });
        btn.classList.add('selected');

        // Update summary
        var dateObj = new Date(selectedDate + 'T00:00:00');
        var options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        var formattedDate = dateObj.toLocaleDateString('en-GB', options);

        var serviceNames = selectedServices.map(function(s) { return s.name; }).join(', ');
        var totalDuration = getTotalDuration();

        document.getElementById('finalServices').textContent = serviceNames;
        document.getElementById('finalDate').textContent = formattedDate;
        document.getElementById('finalTime').textContent = time;
        document.getElementById('finalDuration').textContent = totalDuration + ' minutes';

        // Update form
        var serviceIds = selectedServices.map(function(s) { return s.id; }).join(',');
        document.getElementById('formServiceIds').value = serviceIds;
        document.getElementById('formBookingDate').value = selectedDate;
        document.getElementById('formBookingTime').value = time;
        document.getElementById('formTotalDuration').value = totalDuration;

        // Show continue section
        document.getElementById('continueSection').classList.add('show');

        // Scroll to continue section
        document.getElementById('continueSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Helper to escape HTML
    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
